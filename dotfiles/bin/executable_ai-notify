#!/usr/bin/env bash
set -euo pipefail

: "${ACCEL_OS:?ACCEL_OS must point at repo root}"

payload="${1-}"
if [[ -z $payload ]]; then
  exit 0
fi

type="$(jq -r '.type // empty' <<<"$payload")"
if [[ $type != "agent-turn-complete" ]]; then
  exit 0
fi

title="$(jq -r '."last-assistant-message" // "Turn Complete!"' <<<"$payload")"
message="$(jq -r '."input-messages" // [] | if type=="array" then join(" ") else "" end' <<<"$payload")"
sound_path="$ACCEL_OS/ai/codex/mixkit-correct-answer-tone-2870.wav"

notify-send -t 6000 -i "$ACCEL_OS/ai/codex/chatgpt-logo.svg" "$title" "$message" &
if [[ -f $sound_path ]]; then
  if command -v paplay >/dev/null 2>&1; then
    paplay "$sound_path" >/dev/null 2>&1 &
  elif command -v pw-play >/dev/null 2>&1; then
    pw-play "$sound_path" >/dev/null 2>&1 &
  fi
fi
wait
